<!DOCTYPE html>
<html>
<head>
    <title>SignalR Simple Chat</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-1.10.2.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <style type="text/css">
        .row {
            margin: 20px;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            flex-wrap: wrap;
        }

        .rooms {
            padding: 20px;
            background-color: #ff7f50;
            flex-direction: column;
            height: 400px;
            overflow-x: hidden;
            overflow-y: scroll;
            border-style: solid;
        }

        .chatDiv {
            background-color: #90ee90;
            padding: 20px;
            height: 400px;
            border-style: solid;
            background-color: whitesmoke;
            overflow-x: hidden;
            overflow-y: scroll;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="row" id="welcome"></div>
        <div class="row">
            <div class="rooms col-sm-2" id="rooms"></div>
            <div class="col-sm-1"></div>
            <div class="chatDiv col-sm-9" id="chatDiv">
                <ul id="discussion"></ul>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-3"></div>
            <div class="col-sm-9">
                <input type="text" id="message" autocomplete="off" />
                <input type="submit" id="sendmessage" value="Send" />
                <input type="hidden" id="displayname" />
            </div>
        </div>
    </div>
        <!--Script references. -->
        <!--Reference the SignalR library. -->
        <script src="Scripts/jquery.signalR-2.1.2.min.js"></script>
        <!--Reference the autogenerated SignalR hub script. -->
        <script src="signalr/hubs"></script>
        <!--Add script to update the page and send messages.-->
        <script type="text/javascript">
            var chat;
            var roomName = "main";

            $(function () {
                // Declare a proxy to reference the hub.
                chat = $.connection.chatHub;
                // Create a function that the hub can call to broadcast messages.
                chat.client.addChatMessage = function (name, message) {
                    // Html encode display name and message.
                    var encodedName = $('<div />').text(name).html();
                    var encodedMsg = $('<div />').text(message).html();
                    // Add the message to the page.
                    $('#discussion').append('<li><strong>' + encodedName
                        + '</strong>:&nbsp;&nbsp;' + encodedMsg + '</li>');

                    var objDiv = document.getElementById("chatDiv");
                    objDiv.scrollTop = objDiv.scrollHeight;
                };



                // Set initial focus to message input box.
                $('#message').focus();

                // Start the connection.
                $.connection.hub.start().done(function () {
                    // Get the room name and store it
                    roomName = prompt("Please enter chat name", "main");
                    if (roomName == "") {
                        roomName = "main";
                    }



                    // Get the user name and store it to prepend to messages.
                    $('#displayname').val(prompt('Enter your name:', ''));

                    $('#welcome').append("<h4>Welcome " + $('#displayname').val() + "</h4>");

                    chat.server.joinRoom(roomName, $('#displayname').val());
                    chat.server.getGroupList().done(fillGroupList);

                    $('#sendmessage').click(function () {
                        // Call the Send method on the hub.
                        if ($('#message').val() != "") {
                            chat.server.send(roomName, $('#displayname').val(), $('#message').val());
                        }
                        // Clear text box and reset focus for next comment.
                        $('#message').val('').focus();
                    });





                });

                chat.client.broadcastNewGroupCreated = fillGroupList;



                $("#message").keyup(function (event) {
                    if (event.keyCode === 13) {
                        $("#sendmessage").click();
                    }
                });





            });

            function fillGroupList(roomList) {
                $('#rooms').empty();
                for (i = 0; i < roomList.length; i++) {
                    if (roomList[i] == roomName) {
                        $('#rooms').append('<li id="' + roomList[i] + '"><strong>' + roomList[i] + '</strong></li>');
                    }
                    else {
                        $('#rooms').append('<li id="' + roomList[i] + '">' + roomList[i] + '</li>');
                    }
                }

                var roomsDiv = document.getElementById("rooms");
                var groups = roomsDiv.getElementsByTagName('li');
                for (var i = 0; i < groups.length; i++) {
                    var group = groups[i];
                    group.addEventListener("click", function (e) {
                        changeGroup(e.currentTarget.id);
                    });
                }
            }

            function changeGroup(newRoomName) {
                chat.server.leaveRoom(roomName, $('#displayname').val());
                chat.server.joinRoom(newRoomName, $('#displayname').val());
                roomName = newRoomName;
                chat.server.getGroupList().done(fillGroupList);
                $('#discussion').empty();
            }


        </script>
</body>
</html>